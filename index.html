<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUmF1Y2hGcmVpIER1byIsInNob3J0X25hbWUiOiJSYXVjaEZyZWkiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzY2N2VlYSIsInRoZW1lX2NvbG9yIjoiIzY2N2VlYSJ9">
    <title>RauchFrei Duo - Gemeinsam zum Ziel</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .user-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .user-btn {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .user-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .user-btn input {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            border: none;
            color: inherit;
            font-weight: 600;
            text-align: center;
            width: 90%;
            outline: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--success));
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }
        
        .cigarette-tracker {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .cigarette-btn {
            aspect-ratio: 1;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
        }
        
        .cigarette-btn:active {
            transform: scale(0.95);
        }
        
        .cigarette-btn.smoked {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
            animation: smokedPulse 0.5s ease-out;
        }
        
        @keyframes smokedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .cigarette-btn.emergency {
            border-color: var(--warning);
            background: linear-gradient(135deg, var(--warning), #f59e0b88);
            color: white;
        }
        
        .cigarette-time {
            font-size: 0.625rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }
        
        .cigarette-btn.smoked .cigarette-time {
            color: white;
        }
        
        .progress-bar {
            height: 2rem;
            background: var(--gray-200);
            border-radius: 1rem;
            overflow: hidden;
            margin: 1rem 0;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            min-width: 50px;
        }
        
        .withdrawal-tracker {
            margin: 1rem 0;
        }
        
        .withdrawal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
        }
        
        .withdrawal-label {
            font-weight: 500;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .withdrawal-scale {
            display: flex;
            gap: 0.25rem;
        }
        
        .scale-btn {
            width: 1.75rem;
            height: 1.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        
        .scale-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.1);
        }
        
        .trigger-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .trigger-tag {
            padding: 0.5rem 1rem;
            background: var(--gray-100);
            border-radius: 2rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .trigger-tag.active {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }
        
        .achievement-card {
            background: linear-gradient(135deg, var(--success), #10b981dd);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: achievementUnlock 0.5s ease-out;
        }
        
        @keyframes achievementUnlock {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .achievement-icon {
            font-size: 2rem;
        }
        
        .achievement-content h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .achievement-content p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .partner-sync {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.75rem;
            margin: 1rem 0;
        }
        
        .partner-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .status-indicator {
            width: 0.75rem;
            height: 0.75rem;
            background: var(--success);
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        .btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }
        
        .btn-secondary:hover {
            background: var(--gray-300);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .coach-message {
            background: linear-gradient(135deg, #667eea22, #764ba222);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        
        .coach-message h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .coach-message p {
            color: var(--gray-700);
            line-height: 1.6;
        }
        
        .tab-navigation {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.25rem;
            margin-bottom: 1rem;
            background: white;
            padding: 0.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            padding: 0.75rem 0.25rem;
            background: transparent;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        
        .tab-btn .tab-icon {
            font-size: 1.25rem;
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .hidden {
            display: none !important;
        }
        
        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .crisis-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3.5rem;
            height: 3.5rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            transition: all 0.2s;
            z-index: 1000;
            animation: crisisPulse 2s infinite;
        }
        
        @keyframes crisisPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .crisis-btn:hover {
            transform: scale(1.1);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            margin-bottom: 1rem;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--gray-900);
        }
        
        .breathing-exercise {
            text-align: center;
            padding: 2rem;
        }
        
        .breath-circle {
            width: 150px;
            height: 150px;
            border: 4px solid var(--primary);
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        
        .breath-circle.breathing {
            animation: breathe 19s ease-in-out;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            21% { transform: scale(1.3); }
            58% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .breath-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .history-entry {
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-date {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .history-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }
        
        .history-stat {
            color: var(--gray-600);
        }
        
        .chart-container {
            height: 200px;
            margin: 1rem 0;
            position: relative;
            background: var(--gray-50);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .chart-bar {
            position: absolute;
            bottom: 2rem;
            background: linear-gradient(to top, var(--primary), var(--success));
            border-radius: 0.25rem 0.25rem 0 0;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
        }
        
        .chart-label {
            position: absolute;
            bottom: 0;
            font-size: 0.625rem;
            color: var(--gray-600);
            transform: translateX(-50%);
        }
        
        .notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
            }
            to {
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .settings-group {
            margin-bottom: 1.5rem;
        }
        
        .settings-group h4 {
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .settings-label {
            font-weight: 500;
            color: var(--gray-700);
        }
        
        .settings-input {
            width: 60px;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.25rem;
            text-align: center;
            font-weight: 600;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--gray-300);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: var(--success);
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        
        @media (max-width: 380px) {
            .tab-navigation {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .tab-btn {
                font-size: 0.7rem;
                padding: 0.5rem 0.25rem;
            }
            
            .cigarette-tracker {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        
        const SmokingCessationApp = () => {
            // Core State
            const [currentUser, setCurrentUser] = useState('A');
            const [activeTab, setActiveTab] = useState('today');
            const [showCrisisModal, setShowCrisisModal] = useState(false);
            const [showNotification, setShowNotification] = useState(null);
            const [editingName, setEditingName] = useState({ A: false, B: false });
            
            // User Data State mit erweiterten Features
            const [userData, setUserData] = useState(() => {
                const saved = localStorage.getItem('smokingData');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // Migration fÃ¼r neue Features
                        if (!parsed.A.weeklyHistory) parsed.A.weeklyHistory = [];
                        if (!parsed.B.weeklyHistory) parsed.B.weeklyHistory = [];
                        if (!parsed.shared.settings) {
                            parsed.shared.settings = {
                                notifications: true,
                                darkMode: false,
                                reminderTime: '20:00',
                                weeklyReduction: true,
                                reductionRate: 1
                            };
                        }
                        return parsed;
                    } catch (e) {
                        console.error('Error parsing saved data:', e);
                    }
                }
                
                return {
                    A: {
                        name: 'Partner A',
                        dailyLimit: 6,
                        emergencyUsed: false,
                        cigarettesToday: [],
                        withdrawalSymptoms: {
                            reizbarkeit: 0,
                            hunger: 0,
                            konzentration: 0,
                            muedigkeit: 0
                        },
                        triggers: [],
                        level: 'Starter',
                        points: 0,
                        streakDays: 0,
                        totalDaysClean: 0,
                        startDate: new Date().toISOString(),
                        history: [],
                        weeklyHistory: [],
                        achievements: [],
                        lastCigaretteTime: null,
                        averageInterval: 0
                    },
                    B: {
                        name: 'Partner B',
                        dailyLimit: 6,
                        emergencyUsed: false,
                        cigarettesToday: [],
                        withdrawalSymptoms: {
                            reizbarkeit: 0,
                            hunger: 0,
                            konzentration: 0,
                            muedigkeit: 0
                        },
                        triggers: [],
                        level: 'Starter',
                        points: 0,
                        streakDays: 0,
                        totalDaysClean: 0,
                        startDate: new Date().toISOString(),
                        history: [],
                        weeklyHistory: [],
                        achievements: [],
                        lastCigaretteTime: null,
                        averageInterval: 0
                    },
                    shared: {
                        lastSync: new Date().toISOString(),
                        achievements: [],
                        weeklyReductionRate: 1,
                        flexibilityUsedThisWeek: false,
                        settings: {
                            notifications: true,
                            darkMode: false,
                            reminderTime: '20:00',
                            weeklyReduction: true,
                            reductionRate: 1
                        }
                    }
                };
            });
            
            // Save to localStorage on change
            useEffect(() => {
                localStorage.setItem('smokingData', JSON.stringify(userData));
            }, [userData]);
            
            // Check and save daily history
            useEffect(() => {
                const checkEndOfDay = () => {
                    const now = new Date();
                    const hours = now.getHours();
                    const minutes = now.getMinutes();
                    
                    // Save history at 23:59
                    if (hours === 23 && minutes === 59) {
                        saveDailyHistory();
                    }
                };
                
                const interval = setInterval(checkEndOfDay, 60000); // Check every minute
                return () => clearInterval(interval);
            }, [userData]);
            
            // Reset daily data at midnight
            useEffect(() => {
                const checkNewDay = () => {
                    const lastCheck = localStorage.getItem('lastDayCheck');
                    const today = new Date().toDateString();
                    
                    if (lastCheck !== today) {
                        // Save yesterday's data before reset
                        if (lastCheck) {
                            saveDailyHistory();
                        }
                        localStorage.setItem('lastDayCheck', today);
                        resetDailyData();
                        
                        // Check for weekly reduction
                        if (userData.shared.settings.weeklyReduction) {
                            checkWeeklyReduction();
                        }
                    }
                };
                
                checkNewDay();
                const interval = setInterval(checkNewDay, 60000);
                return () => clearInterval(interval);
            }, [userData]);
            
            // Notification system
            useEffect(() => {
                if (showNotification) {
                    const timer = setTimeout(() => {
                        setShowNotification(null);
                    }, 3000);
                    return () => clearTimeout(timer);
                }
            }, [showNotification]);
            
            const saveDailyHistory = () => {
                const today = new Date().toDateString();
                setUserData(prev => {
                    const newData = { ...prev };
                    
                    ['A', 'B'].forEach(user => {
                        const cigarettesSmoked = prev[user].cigarettesToday.filter(c => c).length;
                        const avgWithdrawal = Object.values(prev[user].withdrawalSymptoms).reduce((a, b) => a + b, 0) / 4;
                        
                        newData[user].history.push({
                            date: today,
                            cigarettes: cigarettesSmoked,
                            limit: prev[user].dailyLimit,
                            withdrawalAvg: avgWithdrawal,
                            triggers: [...prev[user].triggers]
                        });
                        
                        // Keep only last 30 days
                        if (newData[user].history.length > 30) {
                            newData[user].history.shift();
                        }
                        
                        // Update streak
                        if (cigarettesSmoked <= prev[user].dailyLimit) {
                            newData[user].streakDays++;
                        } else {
                            newData[user].streakDays = 0;
                        }
                    });
                    
                    return newData;
                });
            };
            
            const checkWeeklyReduction = () => {
                const dayOfWeek = new Date().getDay();
                if (dayOfWeek === 1) { // Monday
                    setUserData(prev => {
                        const newData = { ...prev };
                        const reductionRate = prev.shared.settings.reductionRate;
                        
                        ['A', 'B'].forEach(user => {
                            const newLimit = Math.max(0, prev[user].dailyLimit - reductionRate);
                            newData[user].dailyLimit = newLimit;
                            
                            // Add achievement for reduction
                            if (newLimit < prev[user].dailyLimit) {
                                newData[user].points += 50;
                                showNotification(`Wochenziel erreicht! Neues Limit: ${newLimit} Zigaretten`);
                            }
                        });
                        
                        return newData;
                    });
                }
            };
            
            const resetDailyData = () => {
                setUserData(prev => ({
                    ...prev,
                    A: {
                        ...prev.A,
                        cigarettesToday: [],
                        emergencyUsed: false,
                        withdrawalSymptoms: {
                            reizbarkeit: 0,
                            hunger: 0,
                            konzentration: 0,
                            muedigkeit: 0
                        },
                        triggers: [],
                        lastCigaretteTime: null
                    },
                    B: {
                        ...prev.B,
                        cigarettesToday: [],
                        emergencyUsed: false,
                        withdrawalSymptoms: {
                            reizbarkeit: 0,
                            hunger: 0,
                            konzentration: 0,
                            muedigkeit: 0
                        },
                        triggers: [],
                        lastCigaretteTime: null
                    },
                    shared: {
                        ...prev.shared,
                        flexibilityUsedThisWeek: false
                    }
                }));
            };
            
            const recordCigarette = (index, isEmergency = false) => {
                const now = new Date();
                setUserData(prev => {
                    const user = prev[currentUser];
                    const newCigarettes = [...user.cigarettesToday];
                    
                    if (isEmergency && !user.emergencyUsed) {
                        newCigarettes.push({
                            time: now.toISOString(),
                            isEmergency: true
                        });
                        
                        showNotification('Notfall-Zigarette verwendet. Bleib stark! ðŸ’ª');
                        
                        return {
                            ...prev,
                            [currentUser]: {
                                ...user,
                                cigarettesToday: newCigarettes,
                                emergencyUsed: true,
                                lastCigaretteTime: now.toISOString()
                            }
                        };
                    } else if (index < user.dailyLimit && !newCigarettes[index]) {
                        newCigarettes[index] = {
                            time: now.toISOString(),
                            isEmergency: false
                        };
                        
                        // Calculate time since last cigarette
                        let points = 10;
                        if (user.lastCigaretteTime) {
                            const hoursSinceLast = (now - new Date(user.lastCigaretteTime)) / 3600000;
                            if (hoursSinceLast >= 2) points += 5;
                            if (hoursSinceLast >= 3) points += 10;
                            
                            // Update average interval
                            const intervals = [];
                            for (let i = 1; i < newCigarettes.length; i++) {
                                if (newCigarettes[i] && newCigarettes[i-1]) {
                                    intervals.push(
                                        (new Date(newCigarettes[i].time) - new Date(newCigarettes[i-1].time)) / 3600000
                                    );
                                }
                            }
                            const avgInterval = intervals.length > 0 
                                ? intervals.reduce((a, b) => a + b, 0) / intervals.length 
                                : 0;
                            
                            return {
                                ...prev,
                                [currentUser]: {
                                    ...user,
                                    cigarettesToday: newCigarettes,
                                    points: user.points + points,
                                    lastCigaretteTime: now.toISOString(),
                                    averageInterval: avgInterval
                                }
                            };
                        }
                        
                        return {
                            ...prev,
                            [currentUser]: {
                                ...user,
                                cigarettesToday: newCigarettes,
                                points: user.points + points,
                                lastCigaretteTime: now.toISOString()
                            }
                        };
                    }
                    
                    return prev;
                });
            };
            
            const undoCigarette = (index) => {
                setUserData(prev => {
                    const user = prev[currentUser];
                    const newCigarettes = [...user.cigarettesToday];
                    
                    if (newCigarettes[index]) {
                        newCigarettes[index] = null;
                        showNotification('Zigarette rÃ¼ckgÃ¤ngig gemacht');
                        
                        return {
                            ...prev,
                            [currentUser]: {
                                ...user,
                                cigarettesToday: newCigarettes,
                                points: Math.max(0, user.points - 10)
                            }
                        };
                    }
                    
                    return prev;
                });
            };
            
            const updateWithdrawal = (symptom, value) => {
                setUserData(prev => ({
                    ...prev,
                    [currentUser]: {
                        ...prev[currentUser],
                        withdrawalSymptoms: {
                            ...prev[currentUser].withdrawalSymptoms,
                            [symptom]: value
                        }
                    }
                }));
            };
            
            const toggleTrigger = (trigger) => {
                setUserData(prev => {
                    const user = prev[currentUser];
                    const triggers = user.triggers.includes(trigger)
                        ? user.triggers.filter(t => t !== trigger)
                        : [...user.triggers, trigger];
                    
                    return {
                        ...prev,
                        [currentUser]: {
                            ...user,
                            triggers
                        }
                    };
                });
            };
            
            const updateUserName = (user, name) => {
                setUserData(prev => ({
                    ...prev,
                    [user]: {
                        ...prev[user],
                        name: name || `Partner ${user}`
                    }
                }));
                setEditingName(prev => ({ ...prev, [user]: false }));
                showNotification('Name aktualisiert');
            };
            
            const updateSettings = (key, value) => {
                setUserData(prev => ({
                    ...prev,
                    shared: {
                        ...prev.shared,
                        settings: {
                            ...prev.shared.settings,
                            [key]: value
                        }
                    }
                }));
            };
            
            const exportData = () => {
                const dataStr = JSON.stringify(userData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `rauchfrei-duo-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Daten exportiert');
            };
            
            const importData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            setUserData(imported);
                            showNotification('Daten importiert');
                        } catch (error) {
                            showNotification('Fehler beim Import');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            const getCoachingMessage = () => {
                const user = userData[currentUser];
                const cigarettesSmoked = user.cigarettesToday.filter(c => c).length;
                const timeNow = new Date().getHours();
                const avgWithdrawal = Object.values(user.withdrawalSymptoms).reduce((a, b) => a + b, 0) / 4;
                
                if (cigarettesSmoked === 0 && timeNow > 12) {
                    return {
                        title: "Starke Leistung!",
                        message: "Du hast heute noch keine Zigarette geraucht. Dein KÃ¶rper regeneriert sich bereits merklich. Die Sauerstoffversorgung verbessert sich stÃ¼ndlich.",
                        type: "success"
                    };
                } else if (cigarettesSmoked > user.dailyLimit * 0.7 && timeNow < 15) {
                    return {
                        title: "Strategische Anpassung empfohlen",
                        message: `Du hast bereits ${cigarettesSmoked} von ${user.dailyLimit} Zigaretten konsumiert. Plane die verbleibenden bewusst fÃ¼r potenzielle Stress-Situationen ein.`,
                        type: "warning"
                    };
                } else if (avgWithdrawal > 6) {
                    return {
                        title: "Entzugsmanagement",
                        message: "Starke Entzugssymptome erkannt. Das ist eine normale neurologische Anpassung. Nutze die AtemÃ¼bung oder einen kurzen Spaziergang zur Dopamin-Regulation.",
                        type: "info"
                    };
                } else if (user.averageInterval > 2.5) {
                    return {
                        title: "Optimale Verteilung!",
                        message: `Durchschnittlich ${user.averageInterval.toFixed(1)} Stunden zwischen Zigaretten. Exzellente Selbstkontrolle!`,
                        type: "success"
                    };
                } else {
                    } else {
                        return {
            };
            
            const calculateProgress = () => {
                const user = userData[currentUser];
                const cigarettesSmoked = user.cigarettesToday.filter(c => c).length;
                return Math.max(0, ((user.dailyLimit - cigarettesSmoked) / user.dailyLimit) * 100);
            };
            
            const getLevelInfo = (points) => {
                if (points < 100) return { level: 'Starter', icon: 'ðŸŒ±', next: 100 };
                if (points < 500) return { level: 'Fortgeschritten', icon: 'ðŸŒ¿', next: 500 };
                if (points < 1000) return { level: 'Experte', icon: 'ðŸŒ³', next: 1000 };
                if (points < 2000) return { level: 'Meister', icon: 'ðŸ†', next: 2000 };
                return { level: 'Legende', icon: 'ðŸ‘‘', next: null };
            };
            
            const formatTime = (isoString) => {
                if (!isoString) return '';
                const date = new Date(isoString);
                return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            };
            
            const getTimeSinceLastCigarette = () => {
                const user = userData[currentUser];
                if (!user.lastCigaretteTime) return null;
                
                const now = new Date();
                const last = new Date(user.lastCigaretteTime);
                const diffMs = now - last;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                
                if (diffHours > 0) {
                    return `${diffHours}h ${mins}min`;
                } else {
                    return `${mins}min`;
                }
            };
            
            // Render Functions
            const renderTodayTab = () => {
                const user = userData[currentUser];
                const cigarettesSmoked = user.cigarettesToday.filter(c => c).length;
                const coaching = getCoachingMessage();
                const timeSince = getTimeSinceLastCigarette();
                
                return (
                    <>
                        <div className="card">
                            <h3 style={{ marginBottom: '1rem', color: 'var(--gray-800)' }}>
                                Heutiges Kontingent
                            </h3>
                            
                            <div className="stats-grid">
                                <div className="stat-card">
                                    <div className="stat-value">{cigarettesSmoked}/{user.dailyLimit}</div>
                                    <div className="stat-label">Geraucht</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{user.dailyLimit - cigarettesSmoked}</div>
                                    <div className="stat-label">Verbleibend</div>
                                </div>
                            </div>
                            
                            {timeSince && (
                                <div style={{ 
                                    textAlign: 'center', 
                                    padding: '0.75rem', 
                                    background: 'var(--gray-50)', 
                                    borderRadius: '0.5rem',
                                    marginBottom: '1rem'
                                }}>
                                    <div style={{ fontSize: '0.875rem', color: 'var(--gray-600)' }}>
                                        Zeit seit letzter Zigarette
                                    </div>
                                    <div style={{ fontSize: '1.25rem', fontWeight: '600', color: 'var(--primary)' }}>
                                        {timeSince}
                                    </div>
                                </div>
                            )}
                            
                            <div className="progress-bar">
                                <div 
                                    className="progress-fill" 
                                    style={{ width: `${calculateProgress()}%` }}
                                >
                                    {calculateProgress().toFixed(0)}% kontrolliert
                                </div>
                            </div>
                            
                            <div className="cigarette-tracker">
                                {[...Array(user.dailyLimit)].map((_, i) => (
                                    <button
                                        key={i}
                                        className={`cigarette-btn ${user.cigarettesToday[i] ? 'smoked' : ''}`}
                                        onClick={() => user.cigarettesToday[i] ? undoCigarette(i) : recordCigarette(i)}
                                        onDoubleClick={() => user.cigarettesToday[i] && undoCigarette(i)}
                                    >
                                        <span>{user.cigarettesToday[i] ? 'ðŸš¬' : `${i + 1}`}</span>
                                        {user.cigarettesToday[i] && (
                                            <span className="cigarette-time">
                                                {formatTime(user.cigarettesToday[i].time)}
                                            </span>
                                        )}
                                    </button>
                                ))}
                                {!user.emergencyUsed && (
                                    <button
                                        className="cigarette-btn emergency"
                                        onClick={() => recordCigarette(user.dailyLimit, true)}
                                    >
                                        ðŸ†˜
                                    </button>
                                )}
                            </div>
                            
                            <p style={{ fontSize: '0.75rem', color: 'var(--gray-500)', textAlign: 'center', marginTop: '0.5rem' }}>
                                Tipp: Doppelklick zum RÃ¼ckgÃ¤ngigmachen
                            </p>
                        </div>
                        
                        <div className="card">
                            <div className={`coach-message ${coaching.type}`}>
                                <h4>{coaching.title}</h4>
                                <p>{coaching.message}</p>
                            </div>
                        </div>
                    </>
                );
            };
